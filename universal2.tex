\documentclass{article}

\usepackage{amssymb,amsthm,amsmath}
\usepackage{url,html}
\usepackage[longnamesfirst,numbers,sort&compress]{natbib}
\usepackage{cleveref}
\usepackage{paralist}
\usepackage{todonotes}
\usepackage[noend]{algorithmic}

\newcommand{\pref}[1]{(P\ref{#1})}
\newcommand{\psref}[1]{(P\ref{#1}$^{\star}$)}

\newcommand{\R}{\mathbb{R}}

\newtheorem{lemma}{Lemma}

\title{Sparse Induced-Universal Graphs for Planarity}
\author{Louis Esperet, GwenaÃ«l Joret, and Pat Morin}

\begin{document}

\maketitle

\section{Introduction}

Very recently, \citet{dujmovic.esperet.ea:adjacency} described a $(1+o(1))\log n$-bit adjacency labelling scheme for planar graphs.  This means that there is a single function $A:\{0,1\}^*\times\{0,1\}^* \to\{0,1\}$ such that, for any $n$ vertex planar graph $G$ there is a labelling $\ell:V(G)\to\{0,1\}^{(1+o(1))\log n}$ for which $A(\ell(v),\ell(w))=1$ if and only if $vw\in E(G)$.

This result has the following immediate consequence: For every positive integer $n$, there exists a graph $I_n$ having $n^{1+o(1)}$ \emph{vertices} such that, for every $n$-vertex planar graph $G$, $I_n$ contains an induced subgraph isomorphic to $G$.  To see this, let $I_n$ be the graph with vertex set $V(I_n):=\{0,1\}^{(1+o(1))\log n}$ and for which $xy\in E(I_n)$ if and only $A(x,y)=1$.  Then, for any $n$-vertex planar graph $G$ with labelling $\ell$, the induced subgraph $I_n[\{\ell(v):v\in V(G)\}]$ is isomorphic to $V(G)$.
The graph $I_n$ is called an \emph{induced-universal graph} for the class of $n$-vertex planar graphs.

Using one of the main ideas from \cite{dujmovic.esperet.ea:adjacency}, \citet{esperet.joret.ea:sparse} showed that there exists a graph $S_n$ with $n^{1+o(1)}$ \emph{edges} such that, for every $n$-vertex planar graph $G$, $S_n$ contains a subgraph (not necessarily induced) isomorphic to $G$.  The graph $S_n$ is called a \emph{subgraph-universal graph} for the class of $n$-vertex planar graphs.

Notice the contrasts between these two results: $I_n$ contains every $n$-vertex planar graph $G$ as an \emph{induced} subgraph whereas $S_n$ may only contain $G$ as a subgraph.  On the other hand, the graph $S_n$ is sparse, having only $n^{1+o(1)}$ edges whereas $I_n$ has $n^{1+o(1)}$ vertices and may have have $n^{2+o(1)}$ edges.

In this paper we show that, for every positive integer $n$, there exist a sparse induced universal graph $U_n$ for the class of $n$-vertex planar graphs.  More precisely, $U_n$ has $n^{1+o(1)}$ edges and vertices and, for every $n$-vertex planar graph $G$, $U_n$ contains an induced subgraph isomorphic to $G$.


\section{Review of Adjacency Labelling}
\label{review}

We now summarize the most relevant aspects of the adjacency labelling scheme of \citet{dujmovic.esperet.ea:adjacency}.  The scheme works for any $n$-vertex $G$ that such that there exists some treewidth at most $t$ graph $H$ and some path $P$ such that $G$ is a subgraph of $H\boxtimes P$. Without loss of generality, we may assume that the vertices of $P$ are the integers $1,\ldots,h$ in the order they occur on the path $P$ and that, for each $y\in\{1,\ldots,h\}$ there exists at least one $v\in V(H)$ such that $(v,y)\in V(G)$.

Without loss of generality, we may assume that $H$ is an edge-maximal graph of treewidth $t$ and has at least $t+1$ vertices.  Fix a tree decomposition $(B_x:x\in V(T))$ of $H$ in which each bag has size exactly $t+1$ and in which no two bags have the same contents.  Root $T$ at an arbitrary node $r$ and, for each vertex $v$ of $H$, let $C_v:=B_x$ where $x$ is the minimum-depth node of $T$ such that $v\in B_x$.  The vertex set $C_v$ has size $t+1$, includes $v$ and is called the \emph{family clique} of $v$.

Each vertex $w\in C_v$ is called an \emph{$H$-parent} of $v$.  Fix a proper colouring $\varphi:H\to\{1,\ldots,t+1\}$.  For any vertex $v$ of $H$, the \emph{$i$-parent} $p_i(v)$ of $v$ is the unique node $w\in C_v$ with $\varphi(w)=i$.  Note that $v$ is and $H$-parent of itself and, specifically, $v$ is the $\varphi(v)$-parent of itself.

The scheme works as follows. Each vertex $v$ of $H$ is mapped to a real interval $[a_v,b_v]$ in such a way that $vw\in E(H)$ implies that $[a_v,b_v]\cap [a_w,b_w]\neq\emptyset$.  This mapping is also thin, in the following sense:

\begin{compactenum}[(P1)]
    \item for any $x\in \R$, $|\{v\in V(H): x\in[a_v,b_w]\}|\in O(t\log n)$.\label{thin}
\end{compactenum}

For each $y\in\{0,\ldots,n+1\}$, let $L_y:=\{v\in V(H): (v,y)\in V(G)\}$ and let $S_y:=\bigcup_{v\in L_y}C_v$.  The labelling scheme first finds sets $S^+_1,\ldots,S^+_h$ of total size $O(n)$ such that $S^+_y\supseteq S_{y-1}\cup S_y\cup S_{y+1}$.\footnote{The original labelling scheme only uses $S^+_y\supseteq S_{y-1}\cup S_y$ but it is convenient for us to include $S_{y+1}$ as well and this change does not invalidate anything in the original scheme.}

Now the scheme defines a sequence of binary search trees $T_1,\ldots,T_h$ such that, for each $y\in\{1,\ldots,h\}$ and each $v\in S^+_y$, $T_y$ contains at least one $x\in [a_v,b_v]$.  This leads to the following crucial definition: $x_{y}(v)$ is the minimum-depth node $x$ of $T_y$ such that $x\in [a_v,b_v]$. Note that $x_y(v)$ is well-defined since $T_y$ contains at least one node $x\in[a_v,b_v]$.   The following property follows from these definitions and Helly's Theorem:

\begin{compactenum}[(P1)]\setcounter{enumi}{1}
    \item For any $v\in L_y$, there exists a path $P_y(v)$ that begins at the root of $T_y$ and contains every node in $X_y(v):=\{x_{y}(w): w\in C_v\}$.\label{clique-path}
\end{compactenum}

For each $y\in\{1,\ldots,h\}$ and each $v\in L_y$, we define $P_y(v)$ to be the minimum length path in $T_y$ that satisifies \pref{clique-path}, so that $P_y(v)$ begins at the root of $T$ and ends at the maximum-depth node in $X_y(v)$.

The trees $T_1,\ldots,T_h$ are very well-balanced; each tree $T_y$ has height $h(T_y)\le \log|S^+_y|+o(\log n)$.

For each $y\in\{1,\ldots,h\}$ and each node $x$ of $T_y$, let $B_x:=\{v\in S^+_y: x_y(v)=x\}$.  Since $x\in[a_v,b_v]$ for each $v\in B_x$, \pref{thin} implies the following property:
\begin{compactenum}[(P1)]\setcounter{enumi}{2}
    \item $|B_x|\in O(t\log n)$. \label{small-bags-i}
\end{compactenum}
Let $\psi_y:S^+_y\to\{1,\ldots,O(t\log n)\}$ be a colouring of $S^+_y$ such that, for each $x\in V(T)$ and each distinct pair $v,w\in B_x$ $\psi(v)\neq\psi(w)$.

\subsection{The Labels}

For each vertex $(v,y)$ of $G$, the label $\ell(v,y)$ has these parts:

\begin{compactenum}[(L1)]
    \item $\alpha(y)$: a bitstring of length of $\log n-\log |S^+_y|+o(\log n)$.  Given $\alpha(y_1)$ and $\alpha(y_2)$ it is possible to distinguish between the following cases:
    \begin{inparaenum}
        \item $y_1=y_2$;
        \item $y_1=y_2+1$;
        \item $y_1=y_2-1$;
        \item $|y_1-y_2|\ge 2$.
    \end{inparaenum}

    \item $\sigma_y(P_y(v))$: a bitstring of length at most $h(T_y)$ that encodes the path $P_y(v)$ where a 0 (respectively, 1) indicates a step from the current node to its left (respectively, right) child.

    \item $\nu_y(v)$: a bitstring of length $o(\log n)$.  This bitstring is designed so that, for any node $v\in S^+_y\cap S^+_{y+1}$, it is possible to recover $\sigma_{y+1}(P_{y+1}(v))$ given only $\sigma_y(P_y(v))$ and $\nu_y(v)$.

    \item $\varphi(v)$: the colour of $v$ in the proper colouring of $H$ (a bitstring of length $\lceil\log(t+1)\rceil$).

    \item $d_y(x_y(p_i(v)))$\todo{define $d_y(x)$ as the depth of $x$ in $T_y$} for each $i\in\{1,\ldots,t+1\}$ (a bitstring of length $(t+1)\lceil\log(t+1)\rceil$).

    \item $\psi_{y+b}(p_i(v))$ for each $i\in\{1,\ldots,t+1\}$ and each $b\in\{-1,0,1\}$ (a bitstring of length $O(t\log\log n)$).\label{psi}

    \item $a_y(v)$: A bitstring of length $3(t+1)$ that indicates, for each $i\in\{1,\ldots,t+1\}$ and each $b\in\{-1,0,1\}$ whether $G$ contains the edge with endpoints $(v,y)$ and $(p_i(v),y+b)$.
\end{compactenum}

\subsection{Adjacency Testing}

Given inputs $\ell(v_1,y_1)$ and $\ell(v_2,y_2)$, the adjacency testing function $A$ works as follows:
\begin{enumerate}
    \item Using $\alpha(y_1)$ and $\alpha(y_2)$, determine which of the following cases applies:
    \begin{enumerate}[(a)]
        \item $y:=y_1=y_2$.  For each $i\in\{1,\ldots,t+1\}$, determine if $v_1=p_i(v_2)$ (or \textit{vice-versa}) and, if so, use $a_y(v_2)$ (or $a_y(v_1)$, respectively) to determine if $(v_1,y)$ and $(v_2,y)$ are adjacent in $G$. Specifically, if $v_1=p_i(v_2)$ then one of the bits in $a_y(v_2)$ indicates whether or $(v_1,y_1)$ and $(v_2,y_1)$ are adjacent in $G$. If $v_1\neq p_i(v_2)$ and $v_2\neq p_i(v_1)$ for every $i\in\{1,\ldots,h\}$, then $v_1v_2\not\in E(H)$ and hence $(v_1,y)$ and $(v_2,y)$ are not adjacent in $G\subseteq H\boxtimes P$.

        To test if $v_1=p_i(v_2)$, recover $\sigma_y(x_y(p_i(v_2)))$\todo{define $\sigma_y(x)$ as the signature of the path from the root of $T_y$ to $x$.} from $\sigma_y(P_y(v))$ and $d_y(x_y(p_i(v)))$.  Next, recover $d_y(x_y(v_1)):=d_y(x_y(p_{\varphi(v_1)}(v_1)))$ and then  $\sigma_y(x_y(v_1))$ from $\sigma_y(P_y(v_1))$ and $d_y(x_y(v_1))$.

        If $\sigma_y(x_y(p_i(v_2))) \neq \sigma_y(x_y(v_1))$ then $v_1\neq p_i(v_2)$.  Otherwise, $p_i(v_2), v_1 \in B_x$ for some node $x$ of $T_y$ (determined by $\sigma_y(x_y(p_i(v_2))) \neq \sigma_y(x_y(v_1))$).  In this case $v_1=p_i(v_2)$ if and only $\psi_y(v_1)=\psi_y(p_i(v_2))$.  The colour $\psi_y(p_i(v_2))$ is stored explicitly in the label of $(v_2,y_2)$ and $\psi_y(v_1)$ can be recovered from the label of $(v_1,y_1)$ since $\psi_y(v_1)=\psi_y(p_{\varphi(v_1)}(v_1))$.

        \item $y:=y_2=y_1+1$.  In this case, recover $\sigma_y(P_y(v_1))$ from $\sigma_{y_1}(P_{y_1}(v_1))$ and $\nu_{y_1}(v_1)$.  At this point, the algorithm proceeds exactly as in the previous case except that, in the final step one bit of $a_{y_2}(v_2)$ is used to check if $(v_1,y_1)=(p_i(v_2),y_2-1)$ is present in $G$.

        \item $y:=y_1=y_{2+1}$. This case is symmetric to the previous case with the roles and $1$ and $2$ reverse.

        \item $|y_1-y_2|\ge 2$.  In this case $y_1\neq y_2$ and $y_1y_2\not\in E(P)$ and therefore $(v_1,y_1)$ and $(v_2,y_2)$ are not adjacent in $G\subseteq H\boxtimes P$.
    \end{enumerate}
\end{enumerate}

\subsection{Edge Density of the Universal Graph}
\label{density-lower-bound}

We now explain why the universal graph $I_n$ defined by the preceding labelling scheme is dense.  The main issue is that the definition of $P_y(v)$ as the path in $T_y$ that contains every node in $X_y(v):=\{x_y(w):w\in C_v\}$.  The problem comes from the fact that there can be nodes in $X_y(v)$ that have much greater depth than $x_y(v)$.  This ultimately leads to a large complete bipartite graph with sides $L$ and $R$ in which the elements of $L$ all correspond to a single vertex $(v,y)$ of $H\boxtimes P$.

Consider a set of subgraphs $G_1,\ldots,G_k$ of $H\boxtimes P$ that each contain the vertices $(v_0,y),\ldots,(v_k,y)$ and the edges $(v_0,y)(v_i,y)$ for each $i\in\{1,\ldots,k\}$.  Each of these graphs has a labelling scheme in which the vertices of $G_i$ are labelled by a function $\ell_i:V(G_i)\to\{0,1\}^{(1+o(1))\log n}$.  We add an additional subscript, $i$, to all of our notations so that, for example $\sigma_{i,y}(P_{i,y}(v))$ is the part of the label corresponding to $\sigma_y(P_y(v))$ in the labelling $\ell_i$ for $G_i$.

Suppose that, for each $i,j\in\{1,\ldots,k\}$, $\sigma_{i,y}(x_{i,y}(v_0))=\sigma_{j,y}(x_{j,y}(v_0))$ but that $\sigma_{i,y}(P_{i,y}(v_0))\neq\sigma_{j,y}(P_{j,y}(v_0))$.  This just means that, the path from the root is $T_{i,y}$ to $x_{i,y}(v_0)$ is the same for each $i\in\{1,\ldots,k\}$, but the path from $x_{i,y}(v_0)$ to the deepest node in $X_{i,y}$ is different for each $i\in\{1,\ldots,k\}$.  There is nothing about the definition of the labelling scheme that rules out this possibility.  Indeed, it could be that $x_{i,y}(v_0)$ is the root of $T_{i,y}$ for each $i\in\{1,\ldots,k\}$, in which case there is no apriori reason to believe that, for distinct $i,j\in\{1,\ldots,k\}$ that $\sigma_{i,y}(P_{i,y}(v_j))=\sigma_{i,y}(P_{i,y}(v_j))$.  In fact, this seems unlikely.

Therefore, the universal graph $I_n$ contains $k$ distinct vertices $z_1,\ldots,z_k$ each corresponding to $(v_0,y)$ where $z_i=\ell_i(v_0,y)$ is the node corresponding to $(v_0,y_0)$ in the graph $G_i$.  For each $i\in\{1,\ldots,k\}$, $I_n$ also contains $k$ distinct vertices $z_{i,j}=\ell_i(v_j,y)$.  Since $(v_0,y)$ is adjacent to $(v_i,y)$ for each $i\in\{1,\ldots,k\}$, $z_i$ is adjacent to $z_{i,k}$ and therefore $z_i$ has degree at least $k$. Since this is true for each $i\in\{1,\ldots,k\}$, we conclude that, in this example, $I_n$ has at least $k^2$ edges.  Finally, note that there is no sublinear upper bound on $k$. Indeed, it is conceivable that this situation occurs even with $k=n/2$, yielding a universal graph $I_n$ with $\Omega(n^2)$ edges.

\section{A Sparse Universal Graph}

We now describe how to modify the adjacency labelling scheme of \citet{dujmovic.esperet.ea:adjacency} so that the resulting universal subgraph is sparse.  As discussed above, the main obstacle comes from the fact that some vertex $(v,y)$ can have an $i$-parent $w:=p_i(v)$ such that $x_y(w)$ has depth much greater than $x_y(v)$.  In order to avoid this, we modify the function $x_y:S^+_y\to V(T_y)$ to create a new function $x'_y$ that avoids this. This is done by calling the following recursive procedure with the root of $T_y$ as its argument:

\noindent
\begin{minipage}{\textwidth}
    $\textsc{Fixup}(x)$:
    \begin{algorithmic}[1]
        \FOR{each $v\in V(H)$ such that $x_y(v)=x$}
            \FOR{each $w\in C_v \cap S^+_y$}
                \IF{$d_y(x_y(w)) > d_y(x)+1$}
                    \STATE{\COMMENT{make $x_y(w)$ is now a child of $x=x_y(v)$}}
                    \STATE{$x_y(w)\gets\mbox{the depth-$(d_y(x)+1)$ ancestor of $x_y(w)$}$ \label{changes}}
                \ENDIF
            \ENDFOR
        \ENDFOR
        \STATE{\textsc{Fixup}(left child of $u$) (if any)}
        \STATE{\textsc{Fixup}(right child of $u$) (if any)}
    \end{algorithmic}
\end{minipage}

Let $x_y$ denote the original function $x_y:S^+_y\to V(T_y)$ used by \citet{dujmovic.esperet.ea:adjacency} and let $x'_y:S^+_y\to V(T_y)$ denote the new function obtained after running $\textsc{Fixup}(r)$ on the root $r$ of $T_y$.  Observe that the only modifications to $x_T$ that occur do so in Line~\ref{changes} and they involve setting $x'_y(w)$ to an ancestor of $x_y(w)$.  Therefore, for any vertex $v\in S^+_y$, $x'_y(v)$ is a $T$-ancestor of $x_y(v)$.  This immediately implies that that, after running $\textsc{Fixup}(r)$, \pref{clique-path} still holds. Indeed, the same path $P_y(v)$ contains every node in $X_y(v)$.

However, it is not the case that $x'_y$ satisfies \pref{small-bags-i}.  Indeed, $B'_x:=\{v\in S^+_y: x'_y(v)=x\}$ can be much larger than $B_x$ and, even larger than $O(t\log n)$.  The next lemma shows that the size of $B'_x$ is still polylogarithmic in $n$.

\begin{lemma}\label{small-bags-ii-lem}
    For each $y\in\{1,\ldots,h\}$ and each node $x$ of $T_y$, $|B'_x|\in O(t(\log n)^{t+2})$.
\end{lemma}

\begin{proof}
    Let $x$ be some node of $T_y$ and suppose that, for some $w\in S^+_y$ $x'_T(w)=x$.  We can trace $w$ back through a path $w_0,w_1,w_2,..,w_d$ in $H$ such that
    \begin{compactenum}[(a)]
        \item $w_0=w$;
        \item $w_{i-1}$ is an $H$-parent of $w_i$ for each $i\in\{1,...,d\}$;
        \item $x'_y(w_{i})$ is the $T_y$-parent of $x'_y(w_{i-1})$ for each $i\in\{1,...,d\}$; and
        \item $x_T(w_d)=x'_T(w_d)$.
    \end{compactenum}
    In particular $w$ is an $H$-ancestor of $w_d$ and there is a path $w_0,\ldots,w_d$ in $H$ of length at most $d$ between with endpoints $w$ and $w_d$.  In the language of \citet{pilipczuk.siebertz:polynomial} $w_0$ is \emph{$d$-reachable} from $w_d$.  \citet[Lemma~13]{pilipczuk.siebertz:polynomial-arxiv} shows that the number of $d$-reachable $H$-ancestors for any node $v$ in a $t$-tree $H$ is at most $\binom{d+t}{t}$.

    Now, let $x=x_0\ldots,x_k$ be the path from $x=x_0$ to the root $r=x_k$ of $T_y$. By the preceding argument, for each $v\in B'_x$ there exists some $d\in\{0,\ldots,k\}$ such that $w$ is a $d$-reachable $H$-ancestor of some node $v\in B_{x_d}$.  It follows that
    \[
        |B'_x|
            \le \sum_{d=0}^k |B_{x_d}|\binom{t+d}{t}
            \in O(tk^{t+1}\log n)
            \subseteq O(t(\log n)^{t+2}) \enspace . \qedhere
    \]
\end{proof}

Therefore, by \cref{small-bags-ii-lem}, the modified labelling scheme satisfies the following weakening of \pref{small-bags-i}:

\begin{compactenum}[(P1$^{\star}$)]\setcounter{enumi}{2}
    \item $|B_x|\in O(t(\log n)^{t+2})$. \label{small-bags-ii}
\end{compactenum}

Therefore, the labelling scheme obtained with the modified definition of $x_y$ satisfies \pref{thin}, \pref{clique-path}, and \psref{small-bags-ii}.  One can readily verify that this has no effect on the correctness of the labelling scheme and only increases the length of the labels slightly.  In particular, the length of (L\ref{psi}) increases from $O(t\log\log n)$ to $O(t^2\log\log n + t\log t)$.  This occurs because the number of colours needed in the colouring $\psi$ increases from $O(t\log n)$ to $O(t(\log n)^{t+2})$.

\subsection{Counting Edges}

Define the induced-universal graph $U_n$ as the graph obtained from the modified adjacency labelling scheme described in the previous section.  To be precise, $V(U_n)$ contains $\ell_G(v,y)$ for each $n$-vertex graph $G$ with $(v,y)\in V(G)$ that is a subgraph of $H\boxtimes P$ for some $t$-tree $H$ and some path $P$.  Similarly, an edge $\ell_1\ell_2$ is in $I_n$ if and only if there exists an $n$-vertex subgraph $G$ of $H\boxtimes P$ that contains an edge $vw$ such that $\ell_G(v)=\ell_1$ and $\ell_G(w)=\ell_2$.

We will now show that $U_n$ has $n^{1+o(1)}$ edges.  This analysis mostly follows along the same lines as the analysis of \citet{esperet.joret.ea:sparse} but is, by necessity, a little less modular.\footnote{The modular approach used by \citet{esperet.joret.ea:sparse} to describe a subgraph-universal graph can be ruled out by a simple counting argument.  They describe a subgraph-universal graph for $C_d\boxtimes K_\omega\boxtimes P_n$ for $c,\omega\in\Theta(\log n)$.  However, the subgraph $\overline{G}:=C_{\log n/\log\log n}\boxtimes K_\omega$ has $n$ vertices and $\Theta(n\log^2 n/\log\log n)$ edges.  The graph $\overline{G}$ has at least $2^{\Omega(n\log^2 n/\log\log n)}$ non-isomorphic [TODO: check this non-isomorphic part] $n$-vertex subgraphs so any encoding for subgraphs of $\overline{G}$ must use at least $\Omega(n\log^2/\log\log n)$ bits to encode some subgraphs.  Therefore any labelling scheme for subgraphs of $\overline{G}$ must use labels of length at most $\Omega(\log^2 n/\log\log n)$.  Therefore any induced-universal graph for subgraphs of $\overline{G}$ must have $2^{\Omega(\log^2 n/\log\log n)}=n^{\omega(\log n/\log\log n)}$ vertices.}

In this analysis, it will be helpful to think of $\ell(v,y)$ as having three main parts:
\begin{compactenum}[(L1$^\star$)]
    \item $\alpha(y)$: as before, this has length $\log n-\log |S^+_y| + o(\log n)$.
    \item $\sigma_y(x_y(v))$: this has length $k\le \log |S^+_y| + o(\log n)$.
    \item (L3)--(L7) as well as an additional string $b\in\{\varepsilon, 0, 1\}$ such that $\sigma_y(P_y(v)) = \sigma_y(x_y(v))\mathbin{\circ} b$.
\end{compactenum}

Let $y':=\alpha(y)$ and let $x'=\sigma_y(x_y(v))$ and let $z'$ be the bitstring formed by concatenating the strings in (L1$^\star$).  Then we can think of $\ell(v,y)$ as a triple $(x',y',z')$ where $x'$, $y'$, and $z'$ are binary strings with $|x'|+|y'|\le \log n + \lambda$ and $|z'|\le \lambda$ where $\lambda\in o(\log n)$.

For the purposes of counting edges, it will be helpful to think of the graph $U_n$ as a directed graph.

\begin{lemma}\label{flat-edges}
    The graph $U_n$ contains at most $n^{1+o(1)}$ edges of the form $(x_1,y,z_1)(x_2,y,z_2)$.
\end{lemma}

\begin{proof}
    Indeed, if $A(\ell(v_1,y,z_1),\ell(v_2,y,z_2))=1$ then $v_1v_2\in E(H)$, so $v_1$ is an $H$-parent of $v_2$ or vice-versa. This implies that $v_1\in C_{v_2}$ or $v_2\in C_{v_1}$.  Then \pref{clique-path} implies that the path $P_{y}(v_2)$ contains $x_y(v_1)$ or $P_y(v_1)$ contains $x_y(v_2)$.  In either case, $x_y(v_1)$ is a $T$-ancestor or a $T$-descendant of $x_y(v_2)$ so $x_1=\sigma_y(x_y(v_1))$ is a prefix of $x_2=\sigma_y(x_y(v_2))$ or $x_2=\sigma_y(x_y(v_2))$ is a prefix of $x_1=\sigma_y(x_y(v_1))$.  Straightforward counting\todo{Don't be lazy.} (see \cite[Lemma~X]{esperet.joret.ea:sparse}) then shows that, for a fixed value $(x_1,y,z_1)$ there are at most $n^{1+o(1)}/2^{|x_1|}$ choices of $(x_2,z_2)$ such that $x_1$ is a prefix of $x_2$ or vice-versa.  A second round of summing, over choices of $(x_1,z_1)$ shows that the total number of edges of this form is $n^{1+o(1)}$ and completes the proof.
\end{proof}

\begin{lemma}\label{flat-edges}
    The graph $U_n$ contains at most $n^{1+o(1)}$ edges of the form $(x_1,y_1,z_1)(x_2,y_2,z_2)$ with $y_1\neq y_2$ is at most $n^{1+o(1)}$.
\end{lemma}

\begin{proof}
\todo[inline]{Take a bit of time to explain $\alpha(y)$ more carefully so it's clear that, for fixed $y_1$ there are only $O(\log n)$ choices of $y_2$ that results in case (b) or (c).}

\todo[inline]{Next, use the awkward-looking definition of $U_n$ to argue that, if an $(x_1,y_1,z_1)(x_2,y_2,z_2)$ is an edge of $U_n$ it's because there exists a graph $G$ with an edge $(v_1,y_1)(v_2,y_2)$ such that $\ell_G(v_1,y_1)=(x_1,y_1,z_1)$ and $\ell_G(v_2,y_2)=(x_2,y_2,z_2)$ [Notation conflict $y_1$ and $y_2$].  In particular, when computing the labelling $\ell_G$, $v_2\in S^+_{y_1}$.  This means that $x_{y_1}(v_2)$ is defined and is a prefix of $x_{y_1}(v_1)$.   Now the rest of the counting is just like in the last paper.}
\end{proof}



\bibliographystyle{plainnat}
\bibliography{universal2}

\end{document}
